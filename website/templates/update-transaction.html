{% extends "base.html" %}
{% block title %} Update Transaction {% endblock %}
{% import '_macros.html' as macros %}
{% block content %}
<form method="POST">
    <br />
    <h3 align="center">Update Transaction</h3>
    <br />
    <div class="input-group form-group">
      <span class="input-group-text">Type</span>
      <select required class="form-select" name="type" id="type">
        <option value="Income" {% if transaction.type == 'Income' %}selected{% endif %}>Income</option>
        <option value="Expense" {% if transaction.type == 'Expense' %}selected{% endif %}>Expense</option>
        <option value="Transfer" {% if transaction.type == 'Transfer' %}selected{% endif %}>Transfer</option>
      </select>
      <span class="input-group-text">{{ macros.currency_symbol(current_user.currency) }}</span>
      <input required type="number" step="0.01" class="form-control" id="amount" name="amount" value="{{ transaction.amount }}"/>
    </div>
    <br/>
    <div class="input-group form-group">
      <span class="input-group-text">Description</span>
      <input required type="text" class="form-control" id="description" name="description" value="{{ transaction.description }}"/>
      <span class="input-group-text">Date</span>
      <input required type="date" class="form-control" id="date" name="date" value="{{ transaction.date.strftime('%Y-%m-%d') }}"/>
    </div>
    <br/>
    <div class="input-group form-group">
      <span class="input-group-text">From Account</span>
      <select class="form-select" name="account_from_id" id="account_from_id">
        <option value="">Select Account</option>
        {% for account in accounts %}
        <option value="{{ account.id }}" {% if transaction.account_from_id == account.id %}selected{% endif %}>{{ account.name }}</option>
        {% endfor %}
      </select>
      <span class="input-group-text">To Account</span>
      <select class="form-select" name="account_to_id" id="account_to_id">
        <option value="">Select Account</option>
        {% for account in accounts %}
        <option value="{{ account.id }}" {% if transaction.account_to_id == account.id %}selected{% endif %}>{{ account.name }}</option>
        {% endfor %}
      </select>
    </div>
    <br/>
    <div class="input-group form-group">
      <span class="input-group-text">Budget Category</span>
      <select class="form-select" name="budget_category_id" id="budget_category_id">
        <option value="">Select Category</option>
        {% for category in categories %}
        <option value="{{ category.id }}" {% if transaction.budget_category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
        {% endfor %}
      </select>
    </div>
    <br />
    <div class="submit-button" style="display: flex; justify-content: center;">
      <button type="submit" class="btn btn-primary">Update</button>
    </div>  
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      const typeSelect = document.getElementById('type');
      const accountFromSelect = document.getElementById('account_from_id');
      const accountToSelect = document.getElementById('account_to_id');
      const budgetSelect = document.getElementById('budget_category_id');
      const descriptionField = document.getElementById('description');
      const charCount = document.createElement('div');

      // Add character count display for description field
      descriptionField.parentNode.insertBefore(charCount, descriptionField.nextSibling);

      let previousType = typeSelect.value;
      let previousAccountFrom = accountFromSelect.value;
      let previousAccountTo = accountToSelect.value;
      let previousBudget = budgetSelect.value;

      // Function to update account fields based on transaction type
      function updateAccountFields() {
          const selectedType = typeSelect.value;
          console.log("Selected Type on Change:", selectedType);

          // Enable/disable account and budget fields based on the transaction type
          if (selectedType === 'Income') {
              accountToSelect.disabled = false;
              accountToSelect.required = true;
              accountFromSelect.disabled = true;
              accountFromSelect.required = false;
              if (previousType !== 'Transfer') {
                  accountFromSelect.value = '';
              }
              budgetSelect.disabled = true;
              budgetSelect.required = false;
              budgetSelect.value = '';
          } else if (selectedType === 'Expense') {
              accountFromSelect.disabled = false;
              accountFromSelect.required = true;
              accountToSelect.disabled = true;
              accountToSelect.required = false;
              if (previousType !== 'Transfer') {
                  accountToSelect.value = '';
              }
              budgetSelect.disabled = false;
              budgetSelect.required = false;
          } else if (selectedType === 'Transfer') {
              accountFromSelect.disabled = false;
              accountFromSelect.required = true;
              accountToSelect.disabled = false;
              accountToSelect.required = true;
              budgetSelect.disabled = true;
              budgetSelect.required = false;
              budgetSelect.value = '';
          }

          // Restore previous values when switching back
          if (selectedType === previousType) {
              accountFromSelect.value = previousAccountFrom;
              accountToSelect.value = previousAccountTo;
              budgetSelect.value = previousBudget;
          }

          // Debugging statements to check current values
          console.log("Account From ID:", accountFromSelect.value);
          console.log("Account To ID:", accountToSelect.value);
          console.log("Budget Category ID:", budgetSelect.value);

          previousType = selectedType;
          previousAccountFrom = accountFromSelect.value;
          previousAccountTo = accountToSelect.value;
          previousBudget = budgetSelect.value;
      }

      // Function to update character count display
      function updateCharCount() {
          charCount.textContent = `${descriptionField.value.length}/250 characters`;
      }

      // Function to limit textarea input to 250 characters
      function limitTextarea() {
          const maxChars = 250;
          descriptionField.addEventListener('input', function() {
              const currentChars = descriptionField.value.length;
              if (currentChars > maxChars) {
                  descriptionField.value = descriptionField.value.slice(0, maxChars);
              }
              updateCharCount();
          });
      }

      // Initial setup
      typeSelect.addEventListener('change', updateAccountFields);
      descriptionField.addEventListener('input', updateCharCount);
      limitTextarea();
      updateAccountFields();

      // Debug initial state
      console.log("Initial Type:", typeSelect.value);
      console.log("Initial Account From ID:", accountFromSelect.value);
      console.log("Initial Account To ID:", accountToSelect.value);
      console.log("Initial Budget Category ID:", budgetSelect.value);
    });
</script>
{% endblock %}